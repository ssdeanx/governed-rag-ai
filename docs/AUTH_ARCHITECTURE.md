# Authentication Architecture

## Overview

This application uses **two separate authentication systems** that serve different purposes:

1. **User Authentication** (Supabase) - For user login/signup
2. **Demo JWT System** (RBAC Tool) - For backend access control testing

**IMPORTANT**: These systems are completely separate. The demo JWT is NOT used for user authentication.

---

## User Authentication (Supabase)

### Purpose
Authenticate real users logging into the application via email/password or GitHub OAuth.

### Flow

#### Email/Password Login

1. User enters credentials on `/login` page
2. Frontend calls `/api/auth/login` endpoint
3. API route calls `supabase.auth.signInWithPassword()`
4. On success, session is stored in HttpOnly cookies (`sb_access_token`, `sb_refresh_token`)
5. User is redirected to home page

#### GitHub OAuth

1. User clicks "GitHub Login" button
2. Frontend redirects to `/api/auth/github`
3. API route calls `supabase.auth.signInWithOAuth({ provider: 'github' })`
4. User authorizes on GitHub
5. GitHub redirects to `/api/auth/callback/github?code=xxx`
6. API route calls `supabase.auth.exchangeCodeForSession(code)`
7. Session is stored in HttpOnly cookies
8. User is redirected to home page

#### Sign Out

1. User clicks sign out
2. Frontend calls `/api/auth/signout`
3. API route calls `supabase.auth.signOut()` and clears cookies
4. User session is terminated

### Cookie Names

- `sb_access_token` - Supabase session access token (HttpOnly, 7 days)
- `sb_refresh_token` - Supabase session refresh token (HttpOnly, 7 days)

### Files Involved

**Frontend:**

- `/app/login/page.tsx` - Login page with email/password form
- `/components/login/AuthForm.joy.tsx` - Login form component

**API Routes:**

- `/app/api/auth/login/route.ts` - Email/password login endpoint
- `/app/api/auth/signup/route.ts` - User registration endpoint
- `/app/api/auth/signout/route.ts` - Sign out endpoint
- `/app/api/auth/github/route.ts` - GitHub OAuth initiation
- `/app/api/auth/callback/github/route.ts` - GitHub OAuth callback

**Utilities:**

- `/lib/auth.ts` - Supabase client helpers and session management
- `/lib/session.ts` - Session verification and access utilities

---

## Backend Authentication (Mastra)

### Purpose of Mastra Authentication

The Mastra backend uses `MastraAuthSupabase` to authenticate API requests made to workflows and agents.

### Configuration
Located in `/src/mastra/index.ts`:

```typescript
export const mastra = new Mastra({
  // ... other config ...
  server: {
    experimental_auth: new MastraAuthSupabase({
      url: process.env.SUPABASE_URL,
      anonKey: process.env.SUPABASE_ANON_KEY
    }),
  },
})
```

### How It Works

1. When frontend makes API call to Mastra backend, it includes Supabase access token in Authorization header
2. `MastraAuthSupabase` validates the token with Supabase
3. If valid, request proceeds; otherwise, 401 Unauthorized

### Integration
Use `createMastraClient(accessToken)` from `/lib/mastra/mastra-client.ts` to create authenticated client:

```typescript
import { createMastraClient } from '@/lib/mastra/mastra-client'
import { getSupabaseAccessToken } from '@/lib/session'

const accessToken = await getSupabaseAccessToken()
const mastraClient = createMastraClient(accessToken)
```

---

## Demo JWT System (RBAC Tool)

### Purpose of Demo JWT System

**This is for backend RBAC demonstration ONLY, not for user authentication.**

The demo JWT system allows testing role-based access control in the backend without creating real user accounts.

### Usage
The JWT generated by `/lib/actions/auth.ts` is used by:

- `/src/mastra/tools/jwt-auth.tool.ts` - Backend tool that validates JWT and enforces RBAC

### How It Works for now

1. For demo/testing purposes, generate a JWT with specific role claims
2. JWT is validated by backend RBAC tool
3. Access to documents is filtered based on role and classification level

### Important Notes

- **NOT used for user login**
- **NOT stored in session cookies**
- **Only for testing RBAC in backend workflows**
- Separate from Supabase authentication

### Files Involved in it

- `/lib/actions/auth.ts` - Generates demo JWTs (clearly documented as demo-only)
- `/src/mastra/tools/jwt-auth.tool.ts` - Validates demo JWTs and enforces RBAC

---

## Environment Variables

### Required for Supabase Auth

```bash
# Supabase Configuration (REQUIRED for authentication)
SUPABASE_URL="https://your-project.supabase.co"
SUPABASE_ANON_KEY="your_supabase_anon_key_here"

# For client-side Supabase (same values)
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your_supabase_anon_key_here"

# Supabase Database Connection (for PostgreSQL storage)
SUPABASE="postgresql://postgres.xxxxx:password@aws-0-us-east-1.pooler.supabase.com:5432/postgres"
```

### Required for GitHub OAuth

```bash
# GitHub OAuth Configuration (for Supabase OAuth)
# Configure these in your Supabase dashboard under Authentication > Providers > GitHub
# Callback URL: https://your-project.supabase.co/auth/v1/callback
GITHUB_CLIENT_ID="your_github_client_id_here"
GITHUB_CLIENT_SECRET="your_github_client_secret_here"
```

### Required for Demo JWT (RBAC Tool)

```bash
# Demo JWT Secret (for RBAC demonstration only, NOT for user authentication)
JWT_SECRET='dev-secret'
TENANT='acme'
```

### Optional

```bash
# Server-side Supabase Auth (for backend services)
USER_EMAIL='user@example.com'
USER_PASSWORD='your_super_secret_password_here'

# Application URL (for OAuth redirects)
NEXT_PUBLIC_APP_URL='http://localhost:3000'
```

---

## Common Patterns

### Protect a Server Component

```typescript
import { requireServerSession } from '@/lib/session'

export default async function ProtectedPage() {
  const session = await requireServerSession() // Throws if not authenticated
  
  return <div>Welcome {session.user.email}</div>
}
```

### Protect an API Route

```typescript
import { requireServerSession } from '@/lib/session'

export async function GET(req: NextRequest) {
  try {
    const session = await requireServerSession()
    // Proceed with authenticated request
  } catch (error) {
    return new Response(JSON.stringify({ error: 'Unauthorized' }), {
      status: 401
    })
  }
}
```

### Make Authenticated Mastra API Call

```typescript
import { createMastraClient } from '@/lib/mastra/mastra-client'
import { getSupabaseAccessToken } from '@/lib/session'

export async function POST(req: NextRequest) {
  const accessToken = await getSupabaseAccessToken()
  
  if (!accessToken) {
    return new Response(JSON.stringify({ error: 'Unauthorized' }), {
      status: 401
    })
  }
  
  const mastraClient = createMastraClient(accessToken)
  // Use mastraClient to call Mastra workflows
}
```

---

## Architecture Diagram

```bash
┌─────────────────────────────────────────────────────────────┐
│                      User Authentication                    │
│                                                             │
│  ┌──────────┐        ┌─────────────┐       ┌──────────────┐ │
│  │  User    │───────▶│  Supabase   │◀──────│  Next.js     │ │
│  │  (Login) │        │  Auth       │       │  API Routes  │ │
│  └──────────┘        └─────────────┘       └──────────────┘ │
│                             │                       │       │
│                             │                       │       │
│                             ▼                       ▼       │
│                    HttpOnly Cookies      Session Utils      │
│                    (sb_access_token)    (lib/session.ts)    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   Backend Authentication                    │
│                                                             │
│  ┌──────────────┐         ┌────────────────┐                │
│  │  Mastra      │◀────────│  MastraAuth    │                │
│  │  Backend     │         │  Supabase      │                │
│  │  (Workflows) │         └────────────────┘                │
│  └──────────────┘                  ▲                        │
│         ▲                          │                        │
│         │                          │                        │
│         │              Validates Token with Supabase        │
│         │                         │                         │
│  ┌──────────────┐                 │                         │
│  │  API Client  │─────────────────┘                         │
│  │  (with token)│                                           │
│  └──────────────┘                                           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Demo JWT (RBAC Tool - Separate)                │
│                                                             │
│  ┌──────────────┐         ┌────────────────┐                │
│  │  RBAC Demo   │────────▶│  jwt-auth      │                │
│  │  Generator   │         │  Tool          │                │
│  │              │         │  (Backend)     │                │
│  └──────────────┘         └────────────────┘                │
│       (lib/actions/auth.ts)    (src/mastra/tools/)          │
│                                                             │
│  NOTE: NOT used for user authentication                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Migration Notes

### What Changed (2025-01-09)

1. **User Authentication**: Now uses Supabase directly instead of demo JWT
2. **Login Flow**: Email/password and GitHub OAuth via Supabase
3. **Session Management**: HttpOnly cookies with Supabase tokens
4. **Backend Auth**: Uses `MastraAuthSupabase` (already configured, no changes)
5. **Demo JWT**: Clearly documented as RBAC tool only, not for user auth

### What Stayed the Same

- Mastra backend authentication configuration (`MastraAuthSupabase`)
- Demo JWT system for RBAC testing
- Backend RBAC tooling and access control

### Benefits

- **Real Authentication**: Users have actual accounts in Supabase
- **OAuth Support**: GitHub login (can add more providers)
- **Secure Sessions**: HttpOnly cookies prevent XSS attacks
- **Clear Separation**: User auth and RBAC demo are completely separate
- **Scalable**: Supabase handles user management, password resets, etc.
