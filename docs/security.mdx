import {
  Badge,
  Button,
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
  Alert,
  AlertDescription,
  AlertTitle,
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
  Mermaid,
  Shield,
  Users,
  Lock,
  Eye,
  EyeOff,
  AlertTriangle,
  CheckCircle,
  ArrowRight,
  FileText,
  Database,
  Settings,
  Key,
} from '@/components/docs/mdx-bridge.joy'


# Security Model

The Mastra Governed RAG implements a robust security framework using role-based access control (RBAC) with hierarchical inheritance, document classifications, and policy enforcement at each stage of the RAG pipeline. Security is integrated into the Mastra workflows to ensure users only access authorized content.

<Alert className="mb-6">
    <Shield className="h-4 w-4" />
    <AlertTitle>Zero-Trust Architecture</AlertTitle>
    <AlertDescription>
        Every query is authenticated and authorized at multiple pipeline stages
        with document access filtered based on user roles and classifications.
    </AlertDescription>
</Alert>

<!-- toc -->

## Role Hierarchy

Roles are defined in `src/mastra/config/role-hierarchy.ts`. Higher-level roles inherit permissions from lower ones, allowing granular access control.

### Role Structure

<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
  <Card>
    <CardHeader className="pb-3">
      <CardTitle className="text-lg flex items-center">
        <Users className="h-5 w-5 mr-2 text-green-500" />
        Public (Level 10)
      </CardTitle>
      <CardDescription>Base access for unauthenticated users</CardDescription>
    </CardHeader>
    <CardContent>
      <ul className="space-y-1 text-sm">
        <li>• No inheritance</li>
        <li>• Basic public documents</li>
        <li>• No sensitive content</li>
      </ul>
    </CardContent>
  </Card>

<Card>
    <CardHeader className="pb-3">
        <CardTitle className="text-lg flex items-center">
            <Users className="h-5 w-5 mr-2 text-blue-500" />
            Employee (Level 40)
        </CardTitle>
        <CardDescription>Inherits public access</CardDescription>
    </CardHeader>
    <CardContent>
        <ul className="space-y-1 text-sm">
            <li>• General company documents</li>
            <li>• Internal policies</li>
            <li>• Department overviews</li>
        </ul>
    </CardContent>
</Card>

<Card>
    <CardHeader className="pb-3">
        <CardTitle className="text-lg flex items-center">
            <Eye className="h-5 w-5 mr-2 text-orange-500" />
            Department Viewer (Level 60)
        </CardTitle>
        <CardDescription>Read access to department content</CardDescription>
    </CardHeader>
    <CardContent>
        <ul className="space-y-1 text-sm">
            <li>• Department-specific content</li>
            <li>• Internal documents</li>
            <li>• Read-only access</li>
        </ul>
    </CardContent>
</Card>

<Card>
    <CardHeader className="pb-3">
        <CardTitle className="text-lg flex items-center">
            <Settings className="h-5 w-5 mr-2 text-purple-500" />
            Department Admin (Level 80)
        </CardTitle>
        <CardDescription>Full department access</CardDescription>
    </CardHeader>
    <CardContent>
        <ul className="space-y-1 text-sm">
            <li>• Full department access</li>
            <li>• Confidential documents</li>
            <li>• Administrative controls</li>
        </ul>
    </CardContent>
</Card>

  <Card>
    <CardHeader className="pb-3">
      <CardTitle className="text-lg flex items-center">
        <Key className="h-5 w-5 mr-2 text-red-500" />
        Super Admin (Level 100)
      </CardTitle>
      <CardDescription>Complete system access</CardDescription>
    </CardHeader>
    <CardContent>
      <ul className="space-y-1 text-sm">
        <li>• All roles and permissions</li>
        <li>• System administration</li>
        <li>• Security overrides</li>
      </ul>
    </CardContent>
  </Card>
</div>

## Role Hierarchy Visualization

<div className="bg-slate-50 dark:bg-slate-900 p-6 rounded-lg border mb-8">
  <Mermaid chart={`flowchart TD
    A[Super Admin<br/>Level 100] --> B[Department Admin<br/>Level 80]
    A --> C[Global Admin<br/>Level 90]

    B --> D[Department Viewer<br/>Level 60]
    C --> D

    D --> E[Employee<br/>Level 40]
    E --> F[Public<br/>Level 10]

    G[Specific Roles] --> D
    G --> E

    H[hr.viewer<br/>Level 60] --> G
    I[finance.viewer<br/>Level 60] --> G
    J[hr.admin<br/>Level 80] --> B
    K[it.admin<br/>Level 80] --> B

    style A fill:#ffebee
    style B fill:#fff3e0
    style D fill:#e8f5e8
    style F fill:#f3e5f5
    style G fill:#e3f2fd`} />

  <div className="mt-4 text-sm text-muted-foreground">
    <strong>Legend:</strong> Higher levels inherit permissions from lower levels. Arrows show inheritance direction.
  </div>
</div>

### Specific Role Examples

<div className="overflow-x-auto mb-6">
    <table className="w-full border-collapse border border-border">
        <thead>
            <tr className="bg-muted">
                <th className="border border-border p-3 text-left">Role</th>
                <th className="border border-border p-3 text-left">Level</th>
                <th className="border border-border p-3 text-left">
                    Inherits From
                </th>
                <th className="border border-border p-3 text-left">
                    Access Scope
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td className="border border-border p-3 font-medium">
                    hr.viewer
                </td>
                <td className="border border-border p-3">60</td>
                <td className="border border-border p-3">employee, public</td>
                <td className="border border-border p-3">HR internal docs</td>
            </tr>
            <tr>
                <td className="border border-border p-3 font-medium">
                    finance.viewer
                </td>
                <td className="border border-border p-3">60</td>
                <td className="border border-border p-3">employee, public</td>
                <td className="border border-border p-3">
                    Finance internal docs
                </td>
            </tr>
            <tr>
                <td className="border border-border p-3 font-medium">
                    engineering.viewer
                </td>
                <td className="border border-border p-3">60</td>
                <td className="border border-border p-3">employee, public</td>
                <td className="border border-border p-3">
                    Engineering internal docs
                </td>
            </tr>
            <tr>
                <td className="border border-border p-3 font-medium">
                    hr.admin
                </td>
                <td className="border border-border p-3">80</td>
                <td className="border border-border p-3">
                    hr.viewer, employee, public
                </td>
                <td className="border border-border p-3">
                    All HR docs including confidential
                </td>
            </tr>
            <tr>
                <td className="border border-border p-3 font-medium">admin</td>
                <td className="border border-border p-3">100</td>
                <td className="border border-border p-3">All roles</td>
                <td className="border border-border p-3">
                    Complete system access
                </td>
            </tr>
        </tbody>
    </table>
</div>

## Document Classifications

Documents are classified during indexing with metadata enforced in storage and retrieval.

<Tabs defaultValue="classifications" className="mb-8">
  <TabsList>
    <TabsTrigger value="classifications">Classifications</TabsTrigger>
    <TabsTrigger value="examples">Sample Documents</TabsTrigger>
    <TabsTrigger value="tags">Security Tags</TabsTrigger>
  </TabsList>

  <TabsContent value="classifications">
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center">
            <Eye className="h-5 w-5 mr-2 text-green-500" />
            Public
          </CardTitle>
          <CardDescription>Accessible by all roles</CardDescription>
        </CardHeader>
        <CardContent>
          <ul className="space-y-1 text-sm">
            <li>• General company information</li>
            <li>• Public policies</li>
            <li>• Marketing materials</li>
            <li>• No sensitive data</li>
          </ul>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center">
            <Lock className="h-5 w-5 mr-2 text-orange-500" />
            Internal
          </CardTitle>
          <CardDescription>Department-specific content</CardDescription>
        </CardHeader>
        <CardContent>
          <ul className="space-y-1 text-sm">
            <li>• Department policies</li>
            <li>• Internal procedures</li>
            <li>• Employee handbooks</li>
            <li>• Limited distribution</li>
          </ul>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center">
            <EyeOff className="h-5 w-5 mr-2 text-red-500" />
            Confidential
          </CardTitle>
          <CardDescription>Highly sensitive information</CardDescription>
        </CardHeader>
        <CardContent>
          <ul className="space-y-1 text-sm">
            <li>• Executive compensation</li>
            <li>• Legal documents</li>
            <li>• Financial data</li>
            <li>• Need-to-know basis only</li>
          </ul>
        </CardContent>
      </Card>
    </div>

  </TabsContent>

  <TabsContent value="examples">
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Finance Policy Manual</CardTitle>
          <CardDescription>finance-policy.md</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center space-x-4 mb-3">
            <Badge variant="secondary">Internal</Badge>
            <Badge variant="outline">Finance</Badge>
            <Badge variant="outline">Policy</Badge>
          </div>
          <div className="text-sm space-y-2">
            <div><strong>Allowed Roles:</strong> finance.viewer, finance.admin, employee</div>
            <div><strong>Classification:</strong> internal</div>
            <div><strong>Tags:</strong> finance, policy, reimbursement</div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Engineering Handbook</CardTitle>
          <CardDescription>engineering-handbook.md</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center space-x-4 mb-3">
            <Badge variant="secondary">Internal</Badge>
            <Badge variant="outline">Engineering</Badge>
            <Badge variant="outline">Development</Badge>
          </div>
          <div className="text-sm space-y-2">
            <div><strong>Allowed Roles:</strong> engineering.viewer, engineering.admin, employee</div>
            <div><strong>Classification:</strong> internal</div>
            <div><strong>Tags:</strong> engineering, development, practices</div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle className="text-lg">HR Confidential</CardTitle>
          <CardDescription>hr-confidential.md</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center space-x-4 mb-3">
            <Badge variant="destructive">Confidential</Badge>
            <Badge variant="outline">HR</Badge>
            <Badge variant="outline">Executive</Badge>
          </div>
          <div className="text-sm space-y-2">
            <div><strong>Allowed Roles:</strong> hr.admin only</div>
            <div><strong>Classification:</strong> confidential</div>
            <div><strong>Tags:</strong> hr, executive, compensation</div>
          </div>
        </CardContent>
      </Card>
    </div>

  </TabsContent>

  <TabsContent value="tags">
    <Card>
      <CardHeader>
        <CardTitle>Security Tag System</CardTitle>
        <CardDescription>How tags control document access</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div>
            <h4 className="font-semibold mb-2">Tag Generation</h4>
            <p className="text-sm text-muted-foreground mb-3">
              Each document chunk stores <code>securityTags: string[]</code> derived from content analysis and metadata.
            </p>
            <div className="bg-muted p-3 rounded text-sm">
              <strong>Example:</strong> finance-policy.md → <code>['finance', 'policy', 'reimbursement']</code>
            </div>
          </div>

          <div>
            <h4 className="font-semibold mb-2">Access Filtering</h4>
            <p className="text-sm text-muted-foreground mb-3">
              User roles determine <code>allowTags: string[]</code> for filtering accessible documents.
            </p>
            <div className="bg-muted p-3 rounded text-sm">
              <strong>Example:</strong> finance.viewer → <code>allowTags: ['finance']</code>
            </div>
          </div>

          <div>
            <h4 className="font-semibold mb-2">Query Filtering</h4>
            <p className="text-sm text-muted-foreground">
              Retrieval queries filter by classification level AND matching security tags.
            </p>
          </div>
        </div>
      </CardContent>
    </Card>

  </TabsContent>
</Tabs>

## Policy Enforcement Pipeline

Security is enforced end-to-end via the Mastra query workflow:

<div className="bg-slate-50 dark:bg-slate-900 p-6 rounded-lg border mb-8">
  <Mermaid chart={`flowchart TD
    A[User Query + JWT] --> B[JWT Validation]
    B --> C{Valid Token?}
    C -->|No| D[Authentication Error]
    C -->|Yes| E[Extract User Role]
    E --> F[Generate Access Filter]
    F --> G{maxClassification + allowTags}
    G --> H[Retrieve Agent]
    H --> I[Vector Search with Filter]
    I --> J[Qdrant DB]
    J --> K[Filter Results]
    K --> L[Authorized Documents Only]
    L --> M[Answer Generation]
    M --> N[Response with Citations]
    D --> O[Error Response]
    N --> P[Final Response]
    style A fill:#e3f2fd
    style H fill:#f3e5f5
    style M fill:#fff3e0
    style N fill:#e8f5e8`} />

  <div className="mt-4 text-sm text-muted-foreground">
    <strong>Security Flow:</strong> Every step validates permissions before proceeding to the next stage.
  </div>
</div>

<div className="space-y-4 mb-8">
  <div className="flex items-center space-x-4">
    <div className="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">1</div>
    <Card className="flex-1">
      <CardHeader className="pb-3">
        <CardTitle className="text-lg">Authentication Step</CardTitle>
        <CardDescription>JWT validation and access filter generation</CardDescription>
      </CardHeader>
      <CardContent>
        <ul className="space-y-1 text-sm">
          <li>• Validate JWT token via AuthenticationService</li>
          <li>• Extract user role from token claims</li>
          <li>• Generate accessFilter with maxClassification and allowTags</li>
          <li>• Example: finance.viewer → maxClassification: 'internal', allowTags: ['finance']</li>
        </ul>
      </CardContent>
    </Card>
  </div>

<div className="flex items-center space-x-4">
    <div className="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">
        2
    </div>
    <Card className="flex-1">
        <CardHeader className="pb-3">
            <CardTitle className="text-lg">Retrieval Step</CardTitle>
            <CardDescription>
                Filtered vector search with security constraints
            </CardDescription>
        </CardHeader>
        <CardContent>
            <ul className="space-y-1 text-sm">
                <li>• Query Qdrant with accessFilter applied</li>
                <li>• Filter by classification ≤ maxClassification</li>
                <li>• Match security tags with allowTags</li>
                <li>• Return only authorized document chunks</li>
            </ul>
        </CardContent>
    </Card>
</div>

<div className="flex items-center space-x-4">
    <div className="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">
        3
    </div>
    <Card className="flex-1">
        <CardHeader className="pb-3">
            <CardTitle className="text-lg">Processing Steps</CardTitle>
            <CardDescription>
                Reranking and answer generation with authorized content
            </CardDescription>
        </CardHeader>
        <CardContent>
            <ul className="space-y-1 text-sm">
                <li>• Rerank agent processes only authorized contexts</li>
                <li>
                    • Answer agent generates responses from filtered content
                </li>
                <li>• Citations limited to accessible documents</li>
                <li>• No information leakage from unauthorized sources</li>
            </ul>
        </CardContent>
    </Card>
</div>

  <div className="flex items-center space-x-4">
    <div className="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">4</div>
    <Card className="flex-1">
      <CardHeader className="pb-3">
        <CardTitle className="text-lg">Verification Step</CardTitle>
        <CardDescription>Final compliance check</CardDescription>
      </CardHeader>
      <CardContent>
        <ul className="space-y-1 text-sm">
          <li>• Verifier agent checks answer for compliance</li>
          <li>• Validates no unauthorized information leakage</li>
          <li>• Ensures citations match accessible documents</li>
          <li>• Fails workflow if security violation detected</li>
        </ul>
      </CardContent>
    </Card>
  </div>
</div>

## Additional Security Features

<div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center">
        <Database className="h-5 w-5 mr-2" />
        Tenant Isolation
      </CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-sm text-muted-foreground">
        All documents are scoped to a specific tenant (configurable in .env as TENANT). This ensures complete data isolation between different organizations or environments.
      </p>
    </CardContent>
  </Card>

<Card>
    <CardHeader>
        <CardTitle className="flex items-center">
            <FileText className="h-5 w-5 mr-2" />
            Audit Logging
        </CardTitle>
    </CardHeader>
    <CardContent>
        <p className="text-sm text-muted-foreground">
            All workflow steps are logged to mastra.log and workflow.log. This
            provides complete audit trails for compliance, monitoring, and
            forensic analysis.
        </p>
    </CardContent>
</Card>

<Card>
    <CardHeader>
        <CardTitle className="flex items-center">
            <Shield className="h-5 w-5 mr-2" />
            ACL Configuration
        </CardTitle>
    </CardHeader>
    <CardContent>
        <p className="text-sm text-muted-foreground">
            Base access control policies are defined in
            src/mastra/policy/acl.yaml. This can be extended for custom security
            rules and organizational requirements.
        </p>
    </CardContent>
</Card>

  <Card>
    <CardHeader>
      <CardTitle className="flex items-center">
        <Key className="h-5 w-5 mr-2" />
        JWT Authentication
      </CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-sm text-muted-foreground">
        Tokens include role claims and are validated via the jwt-auth.tool. This ensures secure authentication with proper role-based access control.
      </p>
    </CardContent>
  </Card>
</div>

## Best Practices

<div className="space-y-4 mb-8">
  <Alert>
    <CheckCircle className="h-4 w-4" />
    <AlertTitle>Principle of Least Privilege</AlertTitle>
    <AlertDescription>
      Always assign users the minimum role necessary for their job function. Use viewer roles by default and admin roles only when required.
    </AlertDescription>
  </Alert>

  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">Document Classification</CardTitle>
      </CardHeader>
      <CardContent>
        <ul className="space-y-2 text-sm">
          <li>• <strong>Public:</strong> General information, no sensitive data</li>
          <li>• <strong>Internal:</strong> Department-specific, business operations</li>
          <li>• <strong>Confidential:</strong> Executive, legal, highly sensitive</li>
          <li>• Always classify documents appropriately during indexing</li>
        </ul>
      </CardContent>
    </Card>

    <Card>
      <CardHeader>
        <CardTitle className="text-lg">Role Management</CardTitle>
      </CardHeader>
      <CardContent>
        <ul className="space-y-2 text-sm">
          <li>• Regularly review and update role assignments</li>
          <li>• Remove access when employees change roles</li>
          <li>• Use inheritance to simplify permission management</li>
          <li>• Document role responsibilities and access levels</li>
        </ul>
      </CardContent>
    </Card>

  </div>

  <Card>
    <CardHeader>
      <CardTitle className="text-lg">Testing and Validation</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        <div className="flex items-center">
          <CheckCircle className="h-4 w-4 mr-2 text-green-500" />
          <span className="text-sm">Use demo roles to simulate different access scenarios</span>
        </div>
        <div className="flex items-center">
          <CheckCircle className="h-4 w-4 mr-2 text-green-500" />
          <span className="text-sm">Test role inheritance and permission boundaries</span>
        </div>
        <div className="flex items-center">
          <CheckCircle className="h-4 w-4 mr-2 text-green-500" />
          <span className="text-sm">Validate document classifications match business requirements</span>
        </div>
        <div className="flex items-center">
          <CheckCircle className="h-4 w-4 mr-2 text-green-500" />
          <span className="text-sm">Regular security audits and access reviews</span>
        </div>
      </div>
    </CardContent>
  </Card>
</div>

<div className="flex gap-4">
    <Button asChild>
        <a href="/docs/demo-roles">
            <Users className="h-4 w-4 mr-2" />
            Try Demo Roles
            <ArrowRight className="h-4 w-4 ml-2" />
        </a>
    </Button>
    <Button variant="outline" asChild>
        <a href="/docs/api-reference">
            <FileText className="h-4 w-4 mr-2" />
            API Reference
        </a>
    </Button>
</div>
