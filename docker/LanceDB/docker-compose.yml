version: '3.8'

services:
    lancedb:
        image: lancedb/lancedb:latest
        container_name: governed-rag-lancedb
        ports:
            - '8000:8000' # LanceDB server port
        volumes:
            - lancedb_data:/data/lancedb
        command: ['lancedb', 'server', '--port', '8000', '--host', '0.0.0.0']
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
            interval: 30s
            timeout: 10s
            retries: 3
        environment:
            - LANCEDB_DATA_DIR=/data/lancedb
            - LANCEDB_LOG_LEVEL=info
        networks:
            - default

    # The Redis Caching Layer
    redis-cache:
        image: redis:7-alpine
        container_name: governed-rag-redis-cache
        ports:
            - '6380:6379' # Use a different port to avoid conflicts
        volumes:
            - redis_cache_data:/data
        command: redis-server --appendonly yes
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - default

volumes:
    lancedb_data:
        driver: local
    redis_cache_data:
        driver: local

networks:
    default:
        name: governed-rag-network
        driver: bridge
